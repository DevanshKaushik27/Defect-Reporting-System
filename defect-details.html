<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Defect Details - Defect Capture System</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Additional styles for defect details page */
    .image-container {
      width: 100%;
      max-width: 400px;
      margin: 0 auto 2rem;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .container {
      max-width: 600px;
      padding-bottom: 3rem;
    }
    
    select, textarea {
      width: 100%;
      padding: 0.8rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1rem;
      margin-bottom: 1rem;
    }
    
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .submit-button {
      background-color: #0f9d58;
    }
    
    .submit-button:hover {
      background-color: #0b8043;
    }
    
    .nav-buttons {
      display: flex;
      justify-content: space-between;
      margin-bottom: 1rem;
    }
    
    .view-mode .form-group input,
    .view-mode .form-group select,
    .view-mode .form-group textarea {
      background-color: #f8f9fa;
      border: 1px solid #e9ecef;
      pointer-events: none;
    }
    
    .view-mode .btn {
      display: none;
    }
    
    .view-mode .back-to-list {
      display: inline-block;
    }
    
    .back-to-list {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="page-title">Defect Details</h1>
    
    <div class="nav-buttons">
      <button class="back-button" id="back-btn">Back</button>
      <button class="back-to-list" id="list-btn">Back to List</button>
    </div>
    
    <div class="image-container">
      <img id="capturedImage" src="" alt="Captured Defect">
    </div>
    
    <div class="defect-form">
      <form id="defectForm">
        <div class="form-group">
          <label for="defectType">Defect Type:</label>
          <select id="defectType" name="defectType" required>
            <option value="">Select Defect Type</option>
            <option value="crack">Crack</option>
            <option value="corrosion">Corrosion</option>
            <option value="deformation">Deformation</option>
            <option value="other">Other</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="severity">Severity:</label>
          <select id="severity" name="severity" required>
            <option value="">Select Severity</option>
            <option value="low">Low</option>
            <option value="medium">Medium</option>
            <option value="high">High</option>
            <option value="critical">Critical</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="location">Location:</label>
          <input type="text" id="location" name="location" required>
        </div>
        
        <div class="form-group">
          <label for="description">Description:</label>
          <textarea id="description" name="description" rows="4" required></textarea>
        </div>
        
        <div class="form-group">
          <label for="assignedTo">Assign To:</label>
          <input type="text" id="assignedTo" name="assignedTo">
        </div>
        
        <div class="form-group" id="status-group" style="display: none;">
          <label for="status">Status:</label>
          <select id="status" name="status">
            <option value="New">New</option>
            <option value="In Progress">In Progress</option>
            <option value="Resolved">Resolved</option>
            <option value="Closed">Closed</option>
          </select>
        </div>
        
        <div class="form-group" id="reportedBy-group" style="display: none;">
          <label for="reportedBy">Reported By:</label>
          <input type="text" id="reportedBy" name="reportedBy" readonly>
        </div>
        
        <div class="form-group" id="timestamp-group" style="display: none;">
          <label for="timestamp">Date Reported:</label>
          <input type="text" id="timestamp" name="timestamp" readonly>
        </div>
        
        <button type="submit" class="btn" id="submit-btn">Submit Defect</button>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const capturedImage = document.getElementById('capturedImage');
      const defectForm = document.getElementById('defectForm');
      const backBtn = document.getElementById('back-btn');
      const listBtn = document.getElementById('list-btn');
      const pageTitle = document.getElementById('page-title');
      const submitBtn = document.getElementById('submit-btn');
      
      // Check if we're in view mode (URL has an ID parameter)
      const urlParams = new URLSearchParams(window.location.search);
      const defectId = urlParams.get('id');
      const isViewMode = defectId !== null;
      
      // Set up back button behavior
      backBtn.addEventListener('click', function() {
        window.history.back();
      });
      
      listBtn.addEventListener('click', function() {
        window.location.href = 'defect-list.html';
      });
      
      if (isViewMode) {
        // We're viewing an existing defect
        pageTitle.textContent = 'View Defect';
        document.querySelector('.defect-form').classList.add('view-mode');
        listBtn.style.display = 'inline-block';
        submitBtn.style.display = 'none';
        
        // Show additional fields for viewing
        document.getElementById('status-group').style.display = 'block';
        document.getElementById('reportedBy-group').style.display = 'block';
        document.getElementById('timestamp-group').style.display = 'block';
        
        // Load the defect data
        loadDefect(defectId);
      } else {
        // We're creating a new defect
        // Get the captured image from localStorage
        const imageData = localStorage.getItem('capturedImage');
        if (imageData) {
          // Validate image data format
          if (!imageData.startsWith('data:image/png;base64,')) {
            console.error('Invalid image format in localStorage');
            alert('Invalid image format. Please capture a new image.');
            window.location.href = 'camera.html';
            return;
          }
          
          // Check if image data is not too small (which would indicate a corrupted image)
          if (imageData.length < 100) {
            console.error('Image data too small, likely corrupted');
            alert('Image appears to be corrupted. Please capture a new image.');
            window.location.href = 'camera.html';
            return;
          }
          
          capturedImage.src = imageData;
          console.log('Image loaded successfully from localStorage');
        } else {
          alert('No image found. Please capture an image first.');
          window.location.href = 'camera.html';
        }

        // Handle form submission for new defect
        defectForm.addEventListener('submit', async function(e) {
          e.preventDefault();

          if (!imageData) {
            alert('No image found. Please capture an image first.');
            return;
          }

          const formData = {
            defectId: 'DEF-' + Date.now(), // Generate a unique ID
            imageUrl: imageData, // In production, this should be the URL after uploading to S3
            defectType: document.getElementById('defectType').value,
            severity: document.getElementById('severity').value,
            location: document.getElementById('location').value,
            description: document.getElementById('description').value,
            assignedTo: document.getElementById('assignedTo').value,
            reportedBy: localStorage.getItem('username') || 'Anonymous', // Get from login
            status: 'New'
          };

          try {
            const response = await fetch('/api/defects', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(formData)
            });

            if (response.ok) {
              const result = await response.json();
              alert('Defect logged successfully!');
              // Clear the stored image
              localStorage.removeItem('capturedImage');
              // Redirect to capture page
              window.location.href = 'capture.html';
            } else {
              const errorData = await response.json().catch(() => ({}));
              const errorMsg = errorData.message || 'Failed to save defect';
              throw new Error(errorMsg);
            }
          } catch (error) {
            console.error('Error:', error);
            alert((error && error.message) ? error.message : 'Failed to save defect. Please try again.');
          }
        });
      }
      
      // Function to load an existing defect
      async function loadDefect(id) {
        try {
          const response = await fetch(`/api/defects/${id}`);
          
          if (!response.ok) {
            throw new Error('Failed to load defect');
          }
          
          const defect = await response.json();
          
          // Populate the form fields
          document.getElementById('defectType').value = defect.defectType;
          document.getElementById('severity').value = defect.severity;
          document.getElementById('location').value = defect.location;
          document.getElementById('description').value = defect.description;
          document.getElementById('assignedTo').value = defect.assignedTo || '';
          document.getElementById('status').value = defect.status;
          document.getElementById('reportedBy').value = defect.reportedBy;
          
          // Format and display the timestamp
          const date = new Date(defect.timestamp);
          document.getElementById('timestamp').value = date.toLocaleString();
          
          // Display the image
          capturedImage.src = defect.imageUrl;
          
        } catch (error) {
          console.error('Error loading defect:', error);
          alert('Failed to load defect details. ' + error.message);
        }
      }
    });
  </script>
</body>
</html> 